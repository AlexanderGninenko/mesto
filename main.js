(()=>{"use strict";class e{constructor(e,t){this._config=e,this._form=t,this._inputList=Array.from(this._form.querySelectorAll(this._config.inputSelector)),this._button=this._form.querySelector(this._config.submitButtonSelector)}_showInputError(e,t){const s=this._form.querySelector(`.${e.id}-error`);e.classList.add(this._config.inputErrorClassActive),s.textContent=t,s.classList.add(this._config.errorClass)}_hideInputError(e){const t=this._form.querySelector(`.${e.id}-error`);t.classList.remove(this._config.errorClass),e.classList.remove(this._config.inputErrorClassActive),t.textContent=""}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_hasInvalidInput(e){return e.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput(this._inputList)?this.disableSubmitButton():this.enableSubmitButton()}_setEventListeners(){this._toggleButtonState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}resetValidation(){this._inputList.forEach((e=>{this._hideInputError(e)}))}enableSubmitButton(){this._button.classList.remove(this._config.inactiveButtonClass),this._button.disabled=!1}disableSubmitButton(){this._button.classList.add(this._config.inactiveButtonClass),this._button.disabled=!0}enableValidation(){this._setEventListeners()}}class t{constructor(e,t,s,r,{handleCardClick:i,handleLikeClick:n,handleConfirmDelete:o}){this._data=e,this._cardSelector=t,this._handleCardClick=i,this._handleLikeClick=n,this._handleConfirmDelete=o,this._api=s,this._id=this._data._id,this._ownerId=this._data.owner._id,this._userId=r}_getCardTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".card").cloneNode(!0)}generateCard(){return this._card=this._getCardTemplate(),this._cardImage=this._card.querySelector(".card__image"),this._setEventListeners(),this._cardImage.src=this._data.link,this._cardImage.alt=this._data.name,this._card.querySelector(".card__title").textContent=this._data.name,this._card.querySelector(".card__like-count").textContent=this._data.likes.length,this._ownerId!==this._userId&&(this._card.querySelector(".card__delete-btn").style.display="none"),this._data.likes.find((e=>this._userId===e._id))&&this._card.querySelector(".card__like-btn").classList.add("card__like-btn_active"),this._card}_setEventListeners(){this._card.querySelector(".card__like-btn").addEventListener("click",(()=>this._handleLikeClick())),this._card.querySelector(".card__delete-btn").addEventListener("click",(()=>this._handleConfirmDelete())),this._card.querySelector(".card__image").addEventListener("click",(()=>{this._handleCardClick({name:this._name,src:this._link})}))}handleLikeCard(){const e=this._card.querySelector(".card__like-btn"),t=this._card.querySelector(".card__like-count");e.classList.contains("card__like-btn_active")?this._api.dislike(this._id).then((s=>{e.classList.remove("card__like-btn_active"),t.textContent=s.likes.length})).catch((e=>{console.log(e)})):this._api.like(this._id).then((s=>{e.classList.add("card__like-btn_active"),t.textContent=s.likes.length})).catch((e=>{console.log(e)}))}handleDeleteCard(){this._card.closest(".card").remove()}}const s={formSelector:".popup__form",inputSelector:".popup__input",inputErrorClass:".popup__input-error",submitButtonSelector:".popup__save-btn",inactiveButtonClass:"popup__save-btn_disabled",inputErrorClassActive:"popup__input_type_error",errorClass:"popup__input-error_active"},r=document.forms.popupProfileForm,i=document.forms.popupPlaceForm,n=document.forms.popupAvatarEditForm,o=(document.querySelector(".popup__input_place_name"),document.querySelector(".popup__input_place_link"),document.querySelector(".popup__input_profile_name")),a=document.querySelector(".popup__input_profile_status"),l=document.querySelector(".profile__add-btn"),c=document.querySelector(".profile__edit-btn"),d=document.querySelector(".profile__avatar-edit-button");class h{constructor(e){this._popupSelector=document.querySelector(e),this._handleOverlayClose=this._handleOverlayClose.bind(this),this._handleEscClose=this._handleEscClose.bind(this)}open(){this._popupSelector.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupSelector.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOverlayClose(e){(e.target.classList.contains("popup__close-icon")||e.target===e.currentTarget)&&this.close()}setEventListeners(){this._popupSelector.querySelector(".popup__close-icon").addEventListener("click",(()=>this.close())),this._popupSelector.addEventListener("mousedown",this._handleOverlayClose)}}class _ extends h{constructor(e,t){super(e),this._submitForm=t,this._popupForm=this._popupSelector.querySelector(".popup__form"),this._inputList=this._popupForm.querySelectorAll(".popup__input"),this._popupButton=this._popupForm.querySelector(".popup__save-btn"),this._popupButtonTextContent=this._popupButton.textContent}_getInputValues(){return this._formValues={},this._inputList.forEach((e=>this._formValues[e.name]=e.value)),this._formValues}setEventListeners(){super.setEventListeners(),this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._submitForm(this._getInputValues())}))}close(){super.close(),this._popupForm.reset()}renderLoading(e){this._popupButton.textContent=e?"Сохранение...":this._popupButtonTextContent}}const p=new e(s,n);p.enableValidation();const u=new e(s,r);u.enableValidation();const m=new e(s,i);m.enableValidation();const v=new class{constructor(e){this._url=e.url,this._headers=e.headers}_checkResponse(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}getUserInfo(){return fetch(this._url+"/users/me",{method:"GET",headers:this._headers}).then(this._checkResponse)}getInitialCards(){return fetch(this._url+"/cards",{method:"GET",headers:this._headers}).then(this._checkResponse)}sendUserInfo(e){return fetch(this._url+"/users/me",{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.about})}).then(this._checkResponse)}addUserCard(e){return fetch(this._url+"/cards",{method:"POST",headers:this._headers,body:JSON.stringify({name:e.name,link:e.link})}).then(this._checkResponse)}like(e){return fetch(this._url+`/cards/likes/${e}`,{method:"PUT",headers:this._headers}).then(this._checkResponse)}dislike(e){return fetch(this._url+`/cards/likes/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}delete(e){return fetch(this._url+`/cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}handleUserAvatar(e){return fetch(this._url+"/users/me/avatar",{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.userAvatar})}).then(this._checkResponse)}getAllNeededData(){return Promise.all([this.getInitialCards(),this.getUserInfo()])}}({url:"https://mesto.nomoreparties.co/v1/cohort-42",headers:{authorization:"15b7f773-dbdf-4b9e-9380-ba8374828004","Content-Type":"application/json"}}),f=new class extends h{constructor(e){super(e),this._popupForm=this._popupSelector.querySelector(".popup__form"),this._popupButton=this._popupForm.querySelector(".popup__save-btn"),this._popupButtonTextContent=this._popupButton.textContent}setEventListeners(){super.setEventListeners(),this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._handleSubmitCallback()}))}setSubmitAction(e){this._handleSubmitCallback=e}renderLoading(e){this._popupButton.textContent=e?"Сохранение...":this._popupButtonTextContent}}(".popup_confirm-delete");f.setEventListeners();const S=new class{constructor(e){this._profileName=document.querySelector(e.name),this._profileStatus=document.querySelector(e.about),this._profileAvatar=document.querySelector(e.avatar)}getUserInfo(){return this._userData={name:this._profileName.textContent,about:this._profileStatus.textContent},this._userData}setUserInfo(e){this._profileName.textContent=e.name,this._profileStatus.textContent=e.about}setUserAvatar(e){this._profileAvatar.src=e.avatar}}({name:".profile__name",about:".profile__status",avatar:".profile__avatar"}),b=new class extends h{constructor(e){super(e),this._popupImage=this._popupSelector.querySelector(".popup__image"),this._popupDescription=this._popupSelector.querySelector(".popup__image-description")}open(e){super.open(),this._popupImage.src=e.link,this._popupImage.alt=e.name,this._popupDescription.textContent=e.name}}(".popup_image");b.setEventListeners();const C=new _(".popup_profile",(e=>{C.renderLoading(!0),v.sendUserInfo(e).then((e=>{S.setUserInfo(e),C.close()})).catch((e=>console.log(e))).finally((()=>C.renderLoading(!1)))}));C.setEventListeners();const g=new _(".popup_place",(e=>{g.renderLoading(!0),v.addUserCard(e).then((e=>{const t=L(e);y.addItem(t),m.disableSubmitButton(),g.close()})).catch((e=>console.log(e))).finally((()=>g.renderLoading(!0)))}));g.setEventListeners();const k=new _(".popup_avatar",(e=>{k.renderLoading(!0),v.handleUserAvatar(e).then((e=>{S.setUserAvatar(e),p.disableSubmitButton(),k.close()})).catch((e=>console.log(e))).finally((()=>k.renderLoading(!1)))}));k.setEventListeners();const L=e=>{const s=new t(e,"#card-template",v,E,{handleCardClick:()=>{b.open(e)},handleLikeClick:()=>{s.handleLikeCard()},handleConfirmDelete:()=>{f.setSubmitAction((()=>{f.renderLoading(!0),v.delete(e._id).then((()=>{s.handleDeleteCard(),f.close()}))}))}});return s.generateCard()},y=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.forEach((e=>this._renderer(e)))}addItem(e){this._container.prepend(e)}}({renderer:e=>{const t=L(e);y.addItem(t)}},".photo-grid__wrapper");let E;l.addEventListener("click",(()=>{m.resetValidation(),m.disableSubmitButton(),g.open()})),c.addEventListener("click",(()=>{const e=S.getUserInfo();o.value=e.name,a.value=e.about,u.resetValidation(),u.enableSubmitButton(),C.open()})),d.addEventListener("click",(()=>{p.resetValidation(),k.open()})),v.getAllNeededData().then((([e,t])=>{S.setUserInfo(t),E=t._id,y.renderItems(e)})).catch((e=>console.log(e)))})();